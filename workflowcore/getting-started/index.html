<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Getting started - Workflow Core</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Getting started";
        var mkdocs_page_input_path = "getting-started.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Workflow Core
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Getting started</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">台阶</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_3">首先，我们定义一些步骤。</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#iworkflow">然后，我们通过组合一系列步骤来定义工作流结构。这是通过实现 IWorkflow 接口来完成的。</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">你还可以内联定义步骤。</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">主持人</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_6">设置</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">用法</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_8">在步骤之间传递数据</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_9">将依赖项注入步骤</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../external-events/">External events</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../activities/">Activity workers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../error-handling/">Error handling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../control-structures/">Control structures</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sagas/">Saga transactions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../json-yaml/">JSON / YAML Definitions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../persistence/">Persistence</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../workflow-middleware/">Middleware</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../multi-node-clusters/">Multi-node clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../using-with-aspnet-core/">ASP.NET Core</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../elastic-search/">Elasticsearch plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../test-helpers/">Test helpers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../extensions/">Extensions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Samples</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Workflow Core</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Getting started</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">基本概念</h1>
<h2 id="_2">台阶</h2>
<p>工作流由一系列相互连接的步骤组成。每个步骤都可以具有输入并产生输出，这些输出可以传递回其所在的工作流。</p>
<p>通过创建从或 <code>StepBodyAsync</code> 抽象类继承的 <code>StepBody</code> 类并实现 Run/RunAsync 方法来定义步骤。它们也可以在定义工作流结构时以内联方式创建。</p>
<h3 id="_3">首先，我们定义一些步骤。</h3>
<pre><code class="language-C#">public class HelloWorld : StepBody
{
    public override ExecutionResult Run(IStepExecutionContext context)
    {
        Console.WriteLine(&quot;Hello world&quot;);
        return ExecutionResult.Next();
    }
}
</code></pre>
<ul>
<li><code>StepBody</code> 和 <code>StepBodyAsync</code> 类实现是由工作流主机构造的，它首先尝试使用 IServiceProvider 进行依赖注入，如果它不能使用此方法构造它，它将搜索无参数构造函数 *</li>
</ul>
<h3 id="iworkflow">然后，我们通过组合一系列步骤来定义工作流结构。这是通过实现 IWorkflow 接口来完成的。</h3>
<pre><code class="language-C#">public class HelloWorldWorkflow : IWorkflow
{
    public string Id =&gt; &quot;HelloWorld&quot;;
    public int Version =&gt; 1;

    public void Build(IWorkflowBuilder&lt;object&gt; builder)
    {
        builder
            .StartWith&lt;HelloWorld&gt;()
            .Then&lt;GoodbyeWorld&gt;();
    }  
}
</code></pre>
<p>该<em>iWorkflow</em>接口还具有只读 ID 属性和只读版本属性。工作流主机使用它们来标识工作流定义。</p>
<p>在 JSON 中实现的工作流如下所示</p>
<pre><code class="language-json">{
  &quot;Id&quot;: &quot;HelloWorld&quot;,
  &quot;Version&quot;: 1,
  &quot;Steps&quot;: [
    {
      &quot;Id&quot;: &quot;Hello&quot;,
      &quot;StepType&quot;: &quot;MyApp.HelloWorld, MyApp&quot;,
      &quot;NextStepId&quot;: &quot;Bye&quot;
    },        
    {
      &quot;Id&quot;: &quot;Bye&quot;,
      &quot;StepType&quot;: &quot;MyApp.GoodbyeWorld, MyApp&quot;
    }
  ]
}
</code></pre>
<h3 id="_4">你还可以内联定义步骤。</h3>
<pre><code class="language-C#">public class HelloWorldWorkflow : IWorkflow
{
    public string Id =&gt; &quot;HelloWorld&quot;;
    public int Version =&gt; 1;

    public void Build(IWorkflowBuilder&lt;object&gt; builder)
    {
        builder
            .StartWith(context =&gt;
            {
                Console.WriteLine(&quot;Hello world&quot;);
                return ExecutionResult.Next();
            })
            .Then(context =&gt;
            {
                Console.WriteLine(&quot;Goodbye world&quot;);
                return ExecutionResult.Next();
            });
    }
}
</code></pre>
<p>在每个步骤之间，每个正在运行的工作流都会保存到选定的持久性提供程序中，可以在以后的某个时间点拾取它以继续执行。步骤的结果可以指示工作流主机将工作流的进一步执行推迟到将来的某个时间点或响应外部事件。</p>
<h2 id="_5">主持人</h2>
<p>工作流主机是负责执行工作流的服务。它通过在持久性提供者中轮询准备运行的工作流实例，执行它们，然后将它们传递回持久性提供者并存储起来，以备下次运行。它还负责将事件发布到可能正在等待的任何工作流。</p>
<h3 id="_6">设置</h3>
<p>使用的<em>添加工作流</em>扩展方法<em>IServiceCollection</em>可以在启动应用程序时配置工作流主机。默认情况下，使用<em>内存持久性提供程序</em>和<em>SingleNodeConcurrencyProvider</em>配置它以进行测试。你还可以在此时配置数据库持久性提供程序。</p>
<pre><code class="language-C#">services.AddWorkflow();
</code></pre>
<h3 id="_7">用法</h3>
<p>当你的应用程序启动时，从内置的依赖注入框架<em>IServiceProvider</em>中获取工作流主机。请确保调用<em>注册工作流</em>，以便工作流主机了解你的所有工作流，然后调用<em>开始（）</em>以启动执行工作流的线程池。使用该<em>开始工作流</em>方法可以启动特定工作流的新实例。</p>
<pre><code class="language-C#">var host = serviceProvider.GetService&lt;IWorkflowHost&gt;();            
host.RegisterWorkflow&lt;HelloWorldWorkflow&gt;();
host.Start();

host.StartWorkflow(&quot;HelloWorld&quot;, 1, null);

Console.ReadLine();
host.Stop();
</code></pre>
<h2 id="_8">在步骤之间传递数据</h2>
<p>每个步骤都是一个黑箱，因此它们支持输入和输出。这些输入和输出可以映射到定义与每个工作流实例相关的自定义数据的数据类。</p>
<p>以下示例说明如何在步骤上定义输入和输出，然后说明如何使用内部数据的类型化类定义工作流，以及如何将输入和输出映射到自定义数据类上的属性。</p>
<pre><code class="language-C#">//Our workflow step with inputs and outputs
public class AddNumbers : StepBody
{
    public int Input1 { get; set; }

    public int Input2 { get; set; }

    public int Output { get; set; }

    public override ExecutionResult Run(IStepExecutionContext context)
    {
        Output = (Input1 + Input2);
        return ExecutionResult.Next();
    }
}

//Our class to define the internal data of our workflow
public class MyDataClass
{
    public int Value1 { get; set; }
    public int Value2 { get; set; }
    public int Answer { get; set; }
}

//Our workflow definition with strongly typed internal data and mapped inputs &amp; outputs
public class PassingDataWorkflow : IWorkflow&lt;MyDataClass&gt;
{  
    public void Build(IWorkflowBuilder&lt;MyDataClass&gt; builder)
    {
        builder            
            .StartWith&lt;AddNumbers&gt;()
                .Input(step =&gt; step.Input1, data =&gt; data.Value1)
                .Input(step =&gt; step.Input2, data =&gt; data.Value2)
                .Output(data =&gt; data.Answer, step =&gt; step.Output)
            .Then&lt;CustomMessage&gt;()
                .Input(step =&gt; step.Message, data =&gt; &quot;The answer is &quot; + data.Answer.ToString());
    }
    ...
}

</code></pre>
<p>或 JSON 格式</p>
<pre><code class="language-json">{
  &quot;Id&quot;: &quot;AddWorkflow&quot;,
  &quot;Version&quot;: 1,
  &quot;DataType&quot;: &quot;MyApp.MyDataClass, MyApp&quot;,
  &quot;Steps&quot;: [
    {
      &quot;Id&quot;: &quot;Add&quot;,
      &quot;StepType&quot;: &quot;MyApp.AddNumbers, MyApp&quot;,
      &quot;NextStepId&quot;: &quot;ShowResult&quot;,
      &quot;Inputs&quot;: { 
          &quot;Input1&quot;: &quot;data.Value1&quot;,
          &quot;Input2&quot;: &quot;data.Value2&quot; 
       },
      &quot;Outputs&quot;: { 
          &quot;Answer&quot;: &quot;step.Output&quot; 
      }
    },    
    {
      &quot;Id&quot;: &quot;ShowResult&quot;,
      &quot;StepType&quot;: &quot;MyApp.CustomMessage, MyApp&quot;,
      &quot;Inputs&quot;: { 
          &quot;Message&quot;: &quot;\&quot;The answer is \&quot; + data.Answer&quot; 
       }
    }
  ]
}
</code></pre>
<p>或 YAML 格式</p>
<pre><code class="language-yaml">Id: AddWorkflow
Version: 1
DataType: MyApp.MyDataClass, MyApp
Steps:
- Id: Add
  StepType: MyApp.AddNumbers, MyApp
  NextStepId: ShowResult
  Inputs:
    Input1: data.Value1
    Input2: data.Value2
  Outputs:
    Answer: step.Output
- Id: ShowResult
  StepType: MyApp.CustomMessage, MyApp
  Inputs:
    Message: '&quot;The answer is &quot; + data.Answer'
</code></pre>
<h2 id="_9">将依赖项注入步骤</h2>
<p>如果你向 IOC 容器注册步骤类，则工作流宿主将使用 IOC 容器来构造它们，并因此注入任何所需的依赖项。此示例说明了对工作流步骤使用依赖项注入。</p>
<p>考虑以下服务</p>
<pre><code class="language-C#">public interface IMyService
{
    void DoTheThings();
}
...
public class MyService : IMyService
{
    public void DoTheThings()
    {
        Console.WriteLine(&quot;Doing stuff...&quot;);
    }
}
</code></pre>
<p>由工作流步骤使用，如下所示</p>
<pre><code class="language-C#">public class DoSomething : StepBody
{
    private IMyService _myService;

    public DoSomething(IMyService myService)
    {
        _myService = myService;
    }

    public override ExecutionResult Run(IStepExecutionContext context)
    {
        _myService.DoTheThings();
        return ExecutionResult.Next();
    }
}
</code></pre>
<p>在设置 IOC 容器时，只需将服务和工作流步骤作为瞬态添加到服务集合中。（避免将步骤注册为单例，因为多个并发工作流可能需要同时使用它们。）</p>
<pre><code class="language-C#">IServiceCollection services = new ServiceCollection();
services.AddLogging();
services.AddWorkflow();

services.AddTransient&lt;DoSomething&gt;();
services.AddTransient&lt;IMyService, MyService&gt;();
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../external-events/" class="btn btn-neutral float-right" title="External events">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../external-events/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
